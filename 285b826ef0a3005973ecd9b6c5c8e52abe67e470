{
  "comments": [
    {
      "key": {
        "uuid": "bd3b4125_36929e90",
        "filename": "/PATCHSET_LEVEL",
        "patchSetId": 21
      },
      "lineNbr": 0,
      "author": {
        "id": 1374077
      },
      "writtenOn": "2020-08-12T09:08:21Z",
      "side": 1,
      "message": "Tried to use it for an actual implementation CL. The fact that GetOrCreateCanonicalPersistentHandle is callable only during Execution phase is too limiting, imho. Many of the heap ref objects (returning handles and/or other refs) are accessed both from the background thread, as well as during serialization, so there needs to be a generic way to construct handles in these ref object methods, which the current implementation does not provide.\n\nnit: Would like to have a GetOrCreateCanonicalPersistentHandle\u003cT\u003e that returns a Handle\u003cT\u003e directly instead of the Address*.",
      "revId": "285b826ef0a3005973ecd9b6c5c8e52abe67e470",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": false
    },
    {
      "key": {
        "uuid": "88d1715b_61068399",
        "filename": "/PATCHSET_LEVEL",
        "patchSetId": 21
      },
      "lineNbr": 0,
      "author": {
        "id": 1119597
      },
      "writtenOn": "2020-08-12T09:21:16Z",
      "side": 1,
      "message": "Could we make that function detect that it doesn\u0027t yet own the handle scope etc. so that it can use the isolate\u0027s handle scope in that case?\nThat would let us use both styles in the code that may run in PrepareJob. Eventually we can migrate everything to using that function, then remove the PersistentHandleScope, make the broker own the handles from the beginning, and remove the special case in that function again.",
      "parentUuid": "bd3b4125_36929e90",
      "revId": "285b826ef0a3005973ecd9b6c5c8e52abe67e470",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": false
    },
    {
      "key": {
        "uuid": "737fb814_537a66a5",
        "filename": "/PATCHSET_LEVEL",
        "patchSetId": 21
      },
      "lineNbr": 0,
      "author": {
        "id": 1327869
      },
      "writtenOn": "2020-08-12T09:49:04Z",
      "side": 1,
      "message": "Ack on the first part. Leszek has been working on that in https://chromium-review.googlesource.com/c/v8/v8/+/2315990.\n\nUpdated public methods to return Handle\u003cT\u003e instead of Address*. I kept the version that returns Address* and made it private so that we can keep it in the .cc.",
      "parentUuid": "bd3b4125_36929e90",
      "revId": "285b826ef0a3005973ecd9b6c5c8e52abe67e470",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": false
    },
    {
      "key": {
        "uuid": "1d80286e_7d85968f",
        "filename": "/PATCHSET_LEVEL",
        "patchSetId": 21
      },
      "lineNbr": 0,
      "author": {
        "id": 1119597
      },
      "writtenOn": "2020-08-12T11:26:20Z",
      "side": 1,
      "message": "Now I\u0027m confused. How does Leszek\u0027s stuff help here?\n\nWe want to be able to use the new broker-\u003eCanonicalPersistenHandle function in phases that may run in the PrepareJob phase. That\u0027s the problem Nico pointed out, I think.",
      "parentUuid": "737fb814_537a66a5",
      "revId": "285b826ef0a3005973ecd9b6c5c8e52abe67e470",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": false
    },
    {
      "key": {
        "uuid": "0119cf27_5262ded3",
        "filename": "/PATCHSET_LEVEL",
        "patchSetId": 21
      },
      "lineNbr": 0,
      "author": {
        "id": 1327869
      },
      "writtenOn": "2020-08-12T12:11:27Z",
      "side": 1,
      "message": "Ah, I see. I thought Nico wanted to use a method that\u0027s called from both serialization and Execute.\n\nWe can update that to be something like:\nif (local_heap_) {\n  create the handle as it is right now with the identity map\n} else {\n  // here we should be in the proper scope\n  return handle(...)\n}\n\nIf this is something that we should discuss further, I can modify the CL and remove from the broker\u0027s API CanonicalPersistentHandle until we reach a consensus. It shouldn\u0027t block the current CL since we are not using that functionality yet.",
      "parentUuid": "1d80286e_7d85968f",
      "revId": "285b826ef0a3005973ecd9b6c5c8e52abe67e470",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": false
    }
  ]
}