{
  "comments": [
    {
      "unresolved": false,
      "key": {
        "uuid": "ce048670_140c047b",
        "filename": "/PATCHSET_LEVEL",
        "patchSetId": 3
      },
      "lineNbr": 0,
      "author": {
        "id": 1519522
      },
      "writtenOn": "2024-10-03T12:41:48Z",
      "side": 1,
      "message": "Thanks for putting this test together, really nice! I wonder if we can make it work with just --stress-compaction as that would be closer to reality. But otherwise, doing it this way should also be fine",
      "revId": "6897ac74cb8fbf3a5a480cfaebba91062e184e9e",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba"
    },
    {
      "unresolved": false,
      "key": {
        "uuid": "186d1b7b_86599528",
        "filename": "/PATCHSET_LEVEL",
        "patchSetId": 3
      },
      "lineNbr": 0,
      "author": {
        "id": 1344750
      },
      "writtenOn": "2024-10-04T09:04:13Z",
      "side": 1,
      "message": "lgtm, thanks for the test!",
      "revId": "6897ac74cb8fbf3a5a480cfaebba91062e184e9e",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "ddb8aa17_d5724fb2",
        "filename": "test/unittests/heap/heap-unittest.cc",
        "patchSetId": 3
      },
      "lineNbr": 752,
      "author": {
        "id": 1519522
      },
      "writtenOn": "2024-10-03T12:41:48Z",
      "side": 1,
      "message": "Would --stress-compaction work if you added 2-3 of these almost-empty segments?",
      "range": {
        "startLine": 751,
        "startChar": 0,
        "endLine": 752,
        "endChar": 15
      },
      "revId": "6897ac74cb8fbf3a5a480cfaebba91062e184e9e",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "ddec322b_521ee8e6",
        "filename": "test/unittests/heap/heap-unittest.cc",
        "patchSetId": 3
      },
      "lineNbr": 752,
      "author": {
        "id": 1356087
      },
      "writtenOn": "2024-10-07T12:56:52Z",
      "side": 1,
      "message": "I looked into before sending the CL and tried again today. I cannot make it work with just `--stress-compaction`.\nTo elaborate: If we want to an entry on segment X to be evacuated, we need to have at least 1 non-empty (so that it\u0027s not discarded) and non-full (so that it contributes to the freelist) segment before X. `--stress-compaction` requires the number of free entries is greater than the number of entries in a segment, so I would need to have at least 2 non-empty non-full segments before X. Because entries are allocated as marked, it takes 2 GCs for to join the freelist. With Scavenger, after 2 GCs an object is promoted to old space, and the object needs to die young for the crash to occur, so there\u0027s not a lot of opportunities to manipulate the EPT. It\u0027s possible for all of this to come together in the wild if the freelist order lines up (which likely takes multiple GC cycles) such that we get the right number of segments and free entries in the young EPT. In a testing scenario, I can\u0027t reasonably recreate the scenario.",
      "parentUuid": "ddb8aa17_d5724fb2",
      "range": {
        "startLine": 751,
        "startChar": 0,
        "endLine": 752,
        "endChar": 15
      },
      "revId": "6897ac74cb8fbf3a5a480cfaebba91062e184e9e",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "293a0638_12f453f1",
        "filename": "test/unittests/heap/heap-unittest.cc",
        "patchSetId": 3
      },
      "lineNbr": 752,
      "author": {
        "id": 1519522
      },
      "writtenOn": "2024-10-09T13:39:32Z",
      "side": 1,
      "message": "I see, thanks for the explanation! I guess I\u0027m asking because this seems like an issue that --stress-compaction should help find, and if that doesn\u0027t work, then maybe this indicates a problem with --stress-compaction?\nFor example, would it work if we changed the logic to be more aggressive, something like:\n```\n  if (v8_flags.stress_compaction) {\n    should_compact \u003d num_segments() \u003e 1;\n    num_segments_to_evacuate \u003d std::max(1u, num_segments_to_evacuate);\n  }\n```\nMaybe that\u0027d be worth trying. I could imagine that that also won\u0027t work because now the evacuation happens too early though, so if that\u0027s the case, let\u0027s just go with your solution.",
      "parentUuid": "ddec322b_521ee8e6",
      "range": {
        "startLine": 751,
        "startChar": 0,
        "endLine": 752,
        "endChar": 15
      },
      "revId": "6897ac74cb8fbf3a5a480cfaebba91062e184e9e",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba"
    },
    {
      "unresolved": false,
      "key": {
        "uuid": "f391c524_60d84323",
        "filename": "test/unittests/heap/heap-unittest.cc",
        "patchSetId": 3
      },
      "lineNbr": 752,
      "author": {
        "id": 1356087
      },
      "writtenOn": "2024-10-09T13:57:53Z",
      "side": 1,
      "message": "Revising the behavior of `--stress-compaction` works.",
      "parentUuid": "293a0638_12f453f1",
      "range": {
        "startLine": 751,
        "startChar": 0,
        "endLine": 752,
        "endChar": 15
      },
      "revId": "6897ac74cb8fbf3a5a480cfaebba91062e184e9e",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba"
    },
    {
      "unresolved": false,
      "key": {
        "uuid": "d8f6e6bd_3586cde7",
        "filename": "test/unittests/heap/heap-unittest.cc",
        "patchSetId": 3
      },
      "lineNbr": 752,
      "author": {
        "id": 1519522
      },
      "writtenOn": "2024-10-09T14:01:08Z",
      "side": 1,
      "message": "Great!",
      "parentUuid": "f391c524_60d84323",
      "range": {
        "startLine": 751,
        "startChar": 0,
        "endLine": 752,
        "endChar": 15
      },
      "revId": "6897ac74cb8fbf3a5a480cfaebba91062e184e9e",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "8d6b651c_3269d962",
        "filename": "test/unittests/heap/heap-unittest.cc",
        "patchSetId": 3
      },
      "lineNbr": 767,
      "author": {
        "id": 1519522
      },
      "writtenOn": "2024-10-03T12:41:48Z",
      "side": 1,
      "message": "Would it be worth asserting that the ExternalPointerHandle of this object changes after GC?",
      "range": {
        "startLine": 767,
        "startChar": 23,
        "endLine": 767,
        "endChar": 38
      },
      "revId": "6897ac74cb8fbf3a5a480cfaebba91062e184e9e",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "82563686_0d5ae6db",
        "filename": "test/unittests/heap/heap-unittest.cc",
        "patchSetId": 3
      },
      "lineNbr": 767,
      "author": {
        "id": 1356087
      },
      "writtenOn": "2024-10-07T12:56:52Z",
      "side": 1,
      "message": "I don\u0027t think it would. I called it `to_be_evacuated` but in practice the entry is marked for evacuation but then the object needs to die. In practice it is never really evacuated, and we should not read the ExternalPointerHandle after the object dies.",
      "parentUuid": "8d6b651c_3269d962",
      "range": {
        "startLine": 767,
        "startChar": 23,
        "endLine": 767,
        "endChar": 38
      },
      "revId": "6897ac74cb8fbf3a5a480cfaebba91062e184e9e",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba"
    },
    {
      "unresolved": false,
      "key": {
        "uuid": "49e55d94_a94aa4a9",
        "filename": "test/unittests/heap/heap-unittest.cc",
        "patchSetId": 3
      },
      "lineNbr": 767,
      "author": {
        "id": 1519522
      },
      "writtenOn": "2024-10-09T13:39:32Z",
      "side": 1,
      "message": "Acknowledged",
      "parentUuid": "82563686_0d5ae6db",
      "range": {
        "startLine": 767,
        "startChar": 23,
        "endLine": 767,
        "endChar": 38
      },
      "revId": "6897ac74cb8fbf3a5a480cfaebba91062e184e9e",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba"
    }
  ]
}