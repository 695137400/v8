{
  "comments": [
    {
      "key": {
        "uuid": "e16f56ea_ee2a3432",
        "filename": "/PATCHSET_LEVEL",
        "patchSetId": 6
      },
      "lineNbr": 0,
      "author": {
        "id": 1162439
      },
      "writtenOn": "2020-07-07T15:23:47Z",
      "side": 1,
      "message": "Thanks, the runtime version looks good. Do you know what the perf impact of this change is? I suppose we have weak ref benchmarks somewhere(?)",
      "revId": "9cbb9b7299061693ee6292905c40690b66bff6e4",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": false
    },
    {
      "key": {
        "uuid": "17cc64a2_839cdd11",
        "filename": "/PATCHSET_LEVEL",
        "patchSetId": 6
      },
      "lineNbr": 0,
      "author": {
        "id": 1274103
      },
      "writtenOn": "2020-07-07T15:49:31Z",
      "side": 1,
      "message": "I don\u0027t know of any weakref benchmarks in tree, but I can try to microbenchmark WeakRef() and WeakRef.prototype.deref() using the latest d8 build and my local d8 build.",
      "parentUuid": "e16f56ea_ee2a3432",
      "revId": "9cbb9b7299061693ee6292905c40690b66bff6e4",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": false
    },
    {
      "key": {
        "uuid": "051bb401_a717108b",
        "filename": "/PATCHSET_LEVEL",
        "patchSetId": 6
      },
      "lineNbr": 0,
      "author": {
        "id": 1274103
      },
      "writtenOn": "2020-07-07T16:07:09Z",
      "side": 1,
      "message": "Not sure how fantastic of a benchmark this is but there don\u0027t appear to be any perf regression from these changes:\n\n$ v8 ./test.js\nconsole.timeEnd: construct, 306.565000\nconsole.timeEnd: construct, 392.078000\nconsole.timeEnd: construct, 545.397000\nconsole.timeEnd: construct, 559.969000\nconsole.timeEnd: construct, 724.751000\nconsole.timeEnd: deref, 23.640000\nconsole.timeEnd: deref, 24.527000\nconsole.timeEnd: deref, 23.357000\nconsole.timeEnd: deref, 24.710000\nconsole.timeEnd: deref, 23.944000\n\n$ ./out.gn/x64.release/d8 ./test.js\nconsole.timeEnd: construct, 272.006000\nconsole.timeEnd: construct, 359.226000\nconsole.timeEnd: construct, 509.458000\nconsole.timeEnd: construct, 517.248000\nconsole.timeEnd: construct, 682.567000\nconsole.timeEnd: deref, 22.989000\nconsole.timeEnd: deref, 24.365000\nconsole.timeEnd: deref, 23.949000\nconsole.timeEnd: deref, 23.787000\nconsole.timeEnd: deref, 23.976000\n\ntest.js:\n\n  \u0027use strict\u0027;\n\n  function testCons() {\n    console.time(\u0027construct\u0027);\n    for (let i \u003d 0; i \u003c 1000000; i +\u003d 1) {\n      new WeakRef({});\n    }\n    console.timeEnd(\u0027construct\u0027);\n  }\n\n\n  function testDeref() {\n    console.time(\u0027deref\u0027);\n    const r \u003d new WeakRef({});\n    for (let i \u003d 0; i \u003c 1000000; i +\u003d 1) {\n      r.deref();\n    }\n    console.timeEnd(\u0027deref\u0027);\n  }\n\n  function megaTest(f) {\n    for (let i \u003d 0; i \u003c 5; i +\u003d 1) {\n      f();\n    }\n  }\n\n  megaTest(testCons);\n  megaTest(testDeref);",
      "parentUuid": "17cc64a2_839cdd11",
      "revId": "9cbb9b7299061693ee6292905c40690b66bff6e4",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": false
    },
    {
      "key": {
        "uuid": "0cc142e0_30d3bd94",
        "filename": "/PATCHSET_LEVEL",
        "patchSetId": 6
      },
      "lineNbr": 0,
      "author": {
        "id": 1362925
      },
      "writtenOn": "2020-07-07T21:34:03Z",
      "side": 1,
      "message": "lgtm with nits addressed.\n\nThanks for porting this to Torque! Just musing: it\u0027s too bad we need a runtime for KeepDuringJob, maybe there\u0027s a clever thing we can do there around GC so we can have it as a fast call...",
      "revId": "9cbb9b7299061693ee6292905c40690b66bff6e4",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": false
    },
    {
      "key": {
        "uuid": "406ce3d4_0306cb94",
        "filename": "src/builtins/weak-ref.tq",
        "patchSetId": 6
      },
      "lineNbr": 7,
      "author": {
        "id": 1362925
      },
      "writtenOn": "2020-07-07T21:34:03Z",
      "side": 1,
      "message": "The convention is runtime functions are in their own toplevel `namespace runtime`.",
      "revId": "9cbb9b7299061693ee6292905c40690b66bff6e4",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "4e20172d_e6f1c717",
        "filename": "src/builtins/weak-ref.tq",
        "patchSetId": 6
      },
      "lineNbr": 12,
      "author": {
        "id": 1362925
      },
      "writtenOn": "2020-07-07T21:34:03Z",
      "side": 1,
      "message": "Given JS constructors already have a `newTarget` and a `target`, `targetAny` may be confusing to read. Maybe `weakRefTargetAny`?",
      "revId": "9cbb9b7299061693ee6292905c40690b66bff6e4",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "128a790e_1a81ae45",
        "filename": "src/builtins/weak-ref.tq",
        "patchSetId": 6
      },
      "lineNbr": 19,
      "author": {
        "id": 1362925
      },
      "writtenOn": "2020-07-07T21:34:03Z",
      "side": 1,
      "message": "Ditto as above. weakRefTarget maybe?",
      "revId": "9cbb9b7299061693ee6292905c40690b66bff6e4",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "eaabeb35_88cb78bb",
        "filename": "src/builtins/weak-ref.tq",
        "patchSetId": 6
      },
      "lineNbr": 49,
      "author": {
        "id": 1362925
      },
      "writtenOn": "2020-07-07T21:34:03Z",
      "side": 1,
      "message": "It\u0027d be good to keep the comment from the C++ version that says that AddToKeptObjects might GC, but since `target` is on stack, it won\u0027t be collected.",
      "revId": "9cbb9b7299061693ee6292905c40690b66bff6e4",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "591e335f_def0dc2e",
        "filename": "src/runtime/runtime-weak-refs.cc",
        "patchSetId": 6
      },
      "lineNbr": 34,
      "author": {
        "id": 1362925
      },
      "writtenOn": "2020-07-07T21:34:03Z",
      "side": 1,
      "message": "Ah, you kept it here. I think it\u0027d be clearer to move the comment to the place I suggested.",
      "revId": "9cbb9b7299061693ee6292905c40690b66bff6e4",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": true
    }
  ]
}